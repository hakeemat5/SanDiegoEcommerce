{% extends 'base.html' %}
{% load static %}

{% block title %}Shop Categories{% endblock %}

{% block content %}

<!-- HEADER -->
<header class="py-13 jarallax" data-jarallax data-speed=".8" style="background-image: url('{% if category_id == 1 %}/static/img/afrocommerce/cart.jpg{% elif category_id == 2 %}/static/img/afrocommerce/restaurant.jpg{% else %}/static/img/afrocommerce/food.jpg{% endif %}');">
  <div class="container">
      <div class="row">
          <div class="col-12">
              <!-- Heading -->
              <h3 class="text-center text-white">{{ service.name }}</h3>

          </div>
      </div>
  </div>
</header>

<section class="py-12">
  <div class="container">
      <div class="row">
          <div class="col-12">
              {% for category, data in categories_with_products.items %}
              <div class="dropdown-section mb-5">
                  <a class="dropdown-toggler" id="{{ category.name|slugify }}Menu" data-toggle="collapse" href="#{{ category.name|slugify }}Collapse" role="button" aria-expanded="false" aria-controls="{{ category.name|slugify }}Collapse">
                      <h4 class="d-flex justify-content-between align-items-center">
                          <span>{{ category.name }}</span>
                          <span class="icon-toggle">
                              <i class="fe fe-chevron-down"></i>
                          </span>
                      </h4>
                  </a>
                  <div class="collapse" id="{{ category.name|slugify }}Collapse">
                      <div class="row" id="product-list">
                          {% if data.products %}
                              {% for product in data.products %}
                              <div class="col-12 col-md-6 col-xl-3 product-card">
                                  <article class="card mb-7 bg-cover rounded shadow-sm product-card" style="min-height: 240px; background-image: url({{ product.image.url }}); transition: transform 0.3s;">
                                      <div class="badge bg-danger card-badge text-uppercase">
                                          {% if product.is_on_sale %}Sale{% endif %}
                                      </div>
                                      <div class="card-img-overlay card-img-overlay-hover align-items-center bg-white-90 rounded">
                                          <div class="text-center">
                                              <p class="fw-bold">{{ product.name }} <br><span class="text-muted">${{ product.price }}</span></p>
                                              <p class="mb-0">
                                                  <button class="btn btn-xs btn-link btn-circle" data-bs-toggle="modal" data-bs-target="#modalProduct{{ product.id }}">
                                                      <i class="fe fe-eye"></i>
                                                  </button>
                                                  <button class="btn btn-xs btn-link btn-circle" onclick="add_to_cart({{ product.id }})">
                                                      <i class="fe fe-shopping-cart"></i>
                                                  </button>
                                              </p>
                                          </div>
                                      </div>
                                  </article>
                              </div>
                              {% include 'partials/modals/modal-product.html' %}
                              {% endfor %}
                          {% else %}
                          <div class="col-12">
                              <p>No products available in this category.</p>
                          </div>
                          {% endif %}
                      </div>
                  </div>
              </div>
              {% endfor %}
          </div>
      </div>

      <div class="row">
          <div class="col-12 text-center">
              <p class="fs-sm text-muted">Showing {{ total_products }} products</p>
              <div class="progress mx-auto mb-7" style="max-width: 250px;">
                  <div class="progress-bar bg-dark" role="progressbar" style="width: {{ data.percentage }}%" aria-valuenow="{{ data.percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <button class="btn btn-sm btn-outline-dark" id="loadMoreBtn">Load more <i class="fe fe-arrow-right"></i></button>
          </div>
      </div>
  </div>
</section>


<style>
  body {
    background-color: #f8f9fa;
  }
  h3 {
    color: #333;
    font-weight: bold;
    margin-bottom: 20px;
  }
  .menu-item {
    border: 1px solid #ccc;
    padding: 15px;
    text-align: center;
    margin-bottom: 15px;
    border-radius: 8px;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  .menu-item:hover {
    background-color: #e9ecef;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  .dropdown-toggler {
    font-size: 20px;
    color: #075806;
    text-decoration: none;
    display: block;
    padding: 10px;
    border-radius: 5px;
    background-color: #d1d6db;
    transition: background-color 0.3s ease;
  }
  .dropdown-toggler:hover {
    background-color: #075806;
    text-decoration: none;
  }
  .dropdown-section {
    margin-top: 40px;
  }
  .product-card {
    position: relative; /* Allow positioning for badges */
  }
  .card-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
  }
  .card-img-overlay {
    transition: background-color 0.3s;
  }
  .card-img-overlay-hover:hover {
    background-color: rgba(255, 255, 255, 0.8);
  }
  .btn-circle {
    border-radius: 50%;
    padding: 10px;
  }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/sweetalert2.all.min.js' %}"></script>
<script>
  // Unified function for quantity control (increase or decrease)
  function updateQuantity(productId, change) {
    const quantityInput = document.getElementById('quantity-' + productId);
    let quantity = parseInt(quantityInput.value, 10) || 1; // Default to 1 if input is invalid

    // Update the quantity with the provided change (positive or negative)
    quantity = Math.max(1, Math.min(10, quantity + change)); // Ensure quantity is between 1 and 10

    quantityInput.value = quantity;
  }

    const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
    
    function add_to_cart(product_id) {
      if (!isAuthenticated) {
        Swal.fire({
          title: 'Please log in!',
          text: 'You need to log in to add products to the cart.',
          icon: 'warning',
          showConfirmButton: true,
          confirmButtonText: 'Log In',
          showCancelButton: true,
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '{% url "login" %}';
          }
        });
        return;
      }
  
      let quantityElement = document.getElementById(`quantity-${product_id}`);
      let quantity = quantityElement ? quantityElement.value : 1;
  
      $.ajax({
        url: "{% url 'add_to_cart' 0 %}".replace('0', product_id),
        type: "POST",
        data: {
          'quantity': quantity,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.success) {
            Swal.fire({
              title: 'Success!',
              text: response.message,
              icon: 'success',
              showConfirmButton: false,
              timer: 1500
            });
            $('#navbar-cart-count').text(response.cart_count);
            $('#cart-button-count').text(response.cart_count);
          } else {
            Swal.fire({
              title: 'Error!',
              text: response.message,
              icon: 'error',
              confirmButtonText: 'Okay'
            });
          }
        },
        error: function() {
          Swal.fire({
            title: 'Oops!',
            text: 'Something went wrong. Please try again.',
            icon: 'error',
            confirmButtonText: 'Okay'
          });
        }
      });
    }
  
  // Load more products function (stub example)
  $('#loadMoreBtn').click(function() {
    // You would typically fetch more products via AJAX here
    console.log('Load more products');
  });
</script>
{% endblock %}
