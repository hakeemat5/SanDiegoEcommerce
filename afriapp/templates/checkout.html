{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block content %} 


    <!-- BREADCRUMB -->
    <nav class="py-5">
      <div class="container">
        <div class="row">
          <div class="col-12">

            <!-- Breadcrumb -->
            <ol class="breadcrumb mb-0 fs-xs text-gray-400">
              <li class="breadcrumb-item">
                <a class="text-gray-400" href="index.html">Home</a>
              </li>
              <li class="breadcrumb-item">
                <a class="text-gray-400" href="shopping-cart.html">Shopping Cart</a>
              </li>
              <li class="breadcrumb-item active">
                Checkout
              </li>
            </ol>

          </div>
        </div>
      </div>
    </nav>

    <!-- CONTENT -->
    <section class="pt-7 pb-12">
      <div class="container">
        <div class="row">
          <div class="col-12 text-center">
            <!-- Heading -->
            <h3 class="mb-4">Checkout</h3>
            <!-- Subheading -->
            <p class="mb-10">
              Already have an account? <a class="fw-bold text-reset" href="#!">Click here to login</a>
            </p>
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-7">
            <!-- Form -->
            <form id="checkout-form" method="POST" action="{% url 'payment_pipeline' %}">
              {% csrf_token %}

              <!-- Hidden inputs -->
              <input type="hidden" name="basket_no" value="{{ cart.basket_no }}">
              <input type="hidden" name="total" value="{{ total_price|floatformat:2 }}">
              <input type="hidden" name="stripe_publishable_key" id="stripe_publishable_key" value="{{ STRIPE_PUBLIC_KEY }}">
              <input type="hidden" name="stripe_token" id="stripe_token" value="">

              <!-- Billing details -->
              <h6 class="mb-7">Billing Details</h6>
              <div class="row mb-9">
                <!-- First Name -->
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label" for="checkoutBillingFirstName">First Name *</label>
                    <input class="form-control form-control-sm" id="checkoutBillingFirstName" name="first_name" type="text" value="{{ user.first_name }}" placeholder="First Name" required>
                  </div>
                </div>
                <!-- Last Name -->
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label" for="checkoutBillingLastName">Last Name *</label>
                    <input class="form-control form-control-sm" id="checkoutBillingLastName" name="last_name" type="text" value="{{ user.last_name }}" placeholder="Last Name" required>
                  </div>
                </div>
                <!-- Email -->
                <div class="col-12">
                  <div class="form-group">
                    <label class="form-label" for="checkoutBillingEmail">Email *</label>
                    <input class="form-control form-control-sm" id="checkoutBillingEmail" name="email" type="email" value="{{ user.email }}" placeholder="Email" required>
                  </div>
                </div>
                <!-- Country -->
                <div class="col-12">
                  <div class="form-group">
                    <label class="form-label" for="checkoutBillingCountry">Country *</label>
                    <input class="form-control form-control-sm" id="checkoutBillingCountry" name="country" type="text" value="{{ user.country }}" placeholder="Country" required>
                  </div>
                </div>
                <!-- Address Line 1 -->
                <div class="col-12">
                  <div class="form-group">
                    <label class="form-label" for="checkoutBillingAddress">Address Line 1 *</label>
                    <input class="form-control form-control-sm" id="checkoutBillingAddress" name="address" type="text" value="{{ user.address }}" placeholder="Address Line 1" required>
                  </div>
                </div>
                <!-- Town / City -->
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label" for="checkoutBillingTown">Town / City *</label>
                    <input class="form-control form-control-sm" id="checkoutBillingTown" name="city" type="text" value="{{ user.city }}" placeholder="Town / City" required>
                  </div>
                </div>
                <!-- ZIP / Postcode -->
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label" for="checkoutBillingZIP">ZIP / Postcode *</label>
                    <input class="form-control form-control-sm" id="checkoutBillingZIP" name="postal_code" type="text" value="{{ user.postcode }}" placeholder="ZIP / Postcode" required>
                  </div>
                </div>
                <!-- Mobile Phone -->
                <div class="col-12">
                  <div class="form-group mb-0">
                    <label class="form-label" for="checkoutBillingPhone">Mobile Phone *</label>
                    <input class="form-control form-control-sm" id="checkoutBillingPhone" name="phone" type="tel" value="{{ user.phone }}" placeholder="Mobile Phone" required>
                  </div>
                </div>
              </div>

              <!-- Payment section -->
              <h6 class="mb-7">Payment</h6>
              <div id="payment-form">
                <div class="form-group">
                  <label for="card-element">Credit or Debit Card *</label>
                  <div id="card-element" class="form-control"></div>
                  <!-- Used to display form errors. -->
                  <div id="card-errors" role="alert"></div>
                </div>
                <button id="submit" class="btn btn-primary btn-lg mt-4" type="submit">Pay ${{ total_price|floatformat:2 }}</button>
              </div>
            </form>
          </div>
          <div class="col-12 col-md-5">
            <div class="card border-0 rounded-3 shadow">
              <div class="card-body">
                <h6 class="mb-7">Order Summary</h6>

                <!-- List group -->
                <div style="max-height: 800px; overflow-y: auto;">
                  <ul class="list-group list-group-lg list-group-flush-y list-group-flush-x mb-7">
                      {% for item in cart %}
                      <li class="list-group-item">
                          <div class="row align-items-center">
                              <div class="col-4">
                                  <!-- Image -->
                                  <a href="{% url 'product' item.product.id %}">
                                      <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="img-fluid">
                                  </a>
                              </div>
                              <div class="col">
                                  <!-- Title -->
                                  <p class="mb-4 fs-sm fw-bold">
                                      <a class="text-body" href="{% url 'product' item.product.id %}">{{ item.product.name }}</a> <br>
                                      <span class="text-muted">${{ item.product.price|floatformat:2 }}</span>
                                  </p>

                                  <!-- Quantity -->
                                  <div class="fs-sm text-muted">
                                      Quantity: {{ item.quantity }} <br>
                                      {% if item.size %}
                                      Size: {{ item.size }} <br>
                                      {% endif %}
                                      {% if item.color %}
                                      Color: {{ item.color }} <br>
                                      {% endif %}
                                      {% if item.product.description %}
                                      Description: {{ item.product.description|truncatewords:15 }} <br> <!-- Truncate long descriptions -->
                                      {% endif %}
                                  </div>

                                  <!-- Remove Item Button -->
                                  <form method="post" action="{% url 'remove_from_cart' item.id %}" class="mt-2">
                                      {% csrf_token %}
                                      <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                                  </form>
                              </div>
                          </div>
                      </li>
                      {% empty %}
                      <li class="list-group-item">Your cart is empty.</li>
                      {% endfor %}
                  </ul>
                </div>


                <div class="d-flex justify-content-between mb-3">
                  <span>Subtotal</span>
                  <span>${{ total_price|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                  <span>Shipping</span>
                  <span>${{ shipping_cost|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                  <span>Tax</span>
                  <span>${{ tax_amount|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                  <span class="fw-bold">Total</span>
                  <span class="fw-bold">${{ total_price }}</span>
                </div>
                <p class="mb-0 fs-sm text-muted">By completing this purchase, you agree to our <a href="#!">Terms and Conditions</a>.</p>
              </div>
            </div>



          </div>
        </div>
      </div>
    </section>

    
    <script src="https://js.stripe.com/v3/"></script>

    <script type="text/javascript">
      // Initialize Stripe with your publishable key
      var stripe = Stripe('{{ STRIPE_PUBLIC_KEY }}');
      var elements = stripe.elements();
  
      // Create an instance of Elements and mount the card element
      var cardElement = elements.create('card');
      cardElement.mount('#card-element');
  
      // Handle form submission
      const form = document.getElementById('checkout-form');
      form.addEventListener('submit', async (event) => {
          event.preventDefault();  // Prevent default form submission
  
          // Create Stripe Payment Method
          const { paymentMethod, error } = await stripe.createPaymentMethod({
              type: 'card',
              card: cardElement,
          });
  
          if (error) {
              // Display error to user
              document.getElementById('card-errors').textContent = error.message;
          } else {
              // No error, add payment method ID to hidden input field
              document.getElementById('stripe_token').value = paymentMethod.id;
  
              // Prepare data to send to the server
              const dataToSend = {
                  'basket_no': document.querySelector('input[name="basket_no"]').value,
                  'shipping_option': document.querySelector('input[name="shipping_option"]:checked') ? document.querySelector('input[name="shipping_option"]:checked').value : null,
                  'total': document.querySelector('input[name="total"]').value,
                  'stripe_token': paymentMethod.id,
              };
  
              // Debugging logs
              console.log(dataToSend);
  
              // Submit data to the server using fetch API
              fetch("{% url 'payment_pipeline' %}", {
                  method: "POST",
                  headers: {
                      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(dataToSend)  // Send data as JSON
              })
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.json();
              })
              .then(session => {
                  if (session.id) {
                      // Redirect to Stripe Checkout page
                      return stripe.redirectToCheckout({ sessionId: session.id });
                  } else {
                      alert("Error: No session ID returned.");
                  }
              })
              .catch(error => {
                  console.error("Error:", error);
                  alert("Payment failed. Please try again.");
              });
          }
      });
  </script>
  


 
{% endblock %}

